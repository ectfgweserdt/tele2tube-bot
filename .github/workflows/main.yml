name: Gemini Automated Media Pipeline

on:
  workflow_dispatch:
    inputs:
      media_title:
        description: 'Target Content (e.g., "Inception" or "Breaking Bad S02")'
        required: true
        type: string

jobs:
  produce_and_publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Python environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install System Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg aria2
        # Verify installations
        ffmpeg -version
        aria2c --version

    - name: Install Python Dependencies
      run: |
        pip install -r requirements.txt

    - name: Run Pipeline
      env:
        # Secrets must be configured in Repo Settings -> Secrets and Variables
        TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
        YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
        YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
      run: |
        python media_orchestrator.py --media "${{ github.event.inputs.media_title }}"

    - name: Upload Logs (Artifacts)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-logs
        path: |
          *.log
          downloads/
